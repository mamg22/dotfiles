#!/bin/sh

queue_file=~/.cache/youtube-download-queue

url="$1"
[ "$1" = "-c" ] && url="$(xsel -bo)"
[ "$url" ] || exit 0

echo "Pressing enter indicates the default"

while true; do
    printf "Video resolution and format to download (p for preview): "
    read -r resolution format

    if [ "$resolution" = "p" ]; then
        if [ -z "$preview_pane" ]; then
            preview_pane="$(tmux split-window -d -v -P -p 80 "video-queue-preview '$url'")"
            trap "tmux kill-pane -t $preview_pane 2>/dev/null; exit 0" INT TERM
        fi

        continue;
    fi

    [ -n "$preview_pane" ] && tmux kill-pane -t "$preview_pane" 2>/dev/null
    break;
done

echo "$url $resolution $format" >> "$queue_file"

exit 0
