#!/bin/sh

filelist=/tmp/kdeconnect-sendfiles-nnn
name="Redmi 7A"
notification_name="KDEConnect Send Files"

# Truncate filelist and set as nnn selection file, avoid possible issues with
# other nnn instances
: > "$filelist"
export NNN_SEL="$filelist.tmp"

$TERMINAL -c floating-st -e nnn -o -p"$filelist"

# Exit on empty selection
[ ! -s "$filelist" ] && exit 0
filecount="$(wc -l "$filelist" | cut -f1 -d' ')"
failcount=0

while read line; do
    if ! kdeconnect-cli -n "$name" --share "$line"; then
        failcount="$((failcount + 1))"
    fi
done < "$filelist"

if [ "$failcount" -eq 0 ]; then
    notify-send "$notification_name" "Sent $filecount files"
elif [ "$failcount" -eq "$filecount" ]; then
    notify-send "$notification_name" "Failed to send all files"
else
    notify-send "$notification_name" "Sent $((filecount - failcount)) files, $failcount failed"
fi
